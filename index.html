<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–ª–∞–π–¥–∏–∫—Å</title>
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            /* Light Theme */
            --bg-color: #eef2f5;
            --text-color: #2d3748;
            --primary-color: #4fd1c5;
            --primary-dark: #38b2ac;
            --wall-color: #a0aec0;
            --floor-color: #e2e8f0;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow-light: #ffffff;
            --shadow-dark: #d1d9e6;
            --modal-bg: white;
            --btn-text: #2d3748;
            
            /* Button Specifics */
            --play-btn-bg: linear-gradient(135deg, #4fd1c5 0%, #319795 100%);
            --play-btn-shadow: rgba(79, 209, 197, 0.4);
            --play-btn-text: #ffffff;
            
            --other-btn-bg: #ffffff;
            --other-btn-border: #e2e8f0;
            --other-btn-text: #4a5568;
        }

        body.dark-mode {
            /* Dark Theme */
            --bg-color: #1a202c;
            --text-color: #f7fafc;
            --primary-color: #4fd1c5;
            --primary-dark: #81e6d9;
            --wall-color: #718096;
            --floor-color: #111319;
            --glass-bg: rgba(26, 32, 44, 0.98);
            --shadow-light: #2d3748;
            --shadow-dark: #000000;
            --modal-bg: #2d3748;
            --btn-text: #f7fafc;
            
            --play-btn-bg: linear-gradient(135deg, #4fd1c5 0%, #2c7a7b 100%);
            --play-btn-shadow: rgba(79, 209, 197, 0.2);
            --play-btn-text: #1a202c;
            
            --other-btn-bg: #2d3748;
            --other-btn-border: #4a5568;
            --other-btn-text: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Nunito', sans-serif;
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100%;
            background: var(--bg-color);
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        canvas {
            display: block;
            width: 100%;
            flex-grow: 1;
            z-index: 1;
            background-color: var(--bg-color); 
        }

        /* --- SCREENS --- */
        .screen {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            pointer-events: auto;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10;
        }

        .screen.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        
        .screen:not(.active) {
            pointer-events: none;
        }

        /* --- TYPOGRAPHY --- */
        h1 {
            font-size: 3.5rem;
            margin: 0 0 2rem 0;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
            letter-spacing: -1px;
            text-align: center;
            line-height: 1.1;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            margin-top: 0;
        }

        p {
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: center;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 25px;
        }

        /* --- BUTTONS --- */
        .btn {
            background: var(--bg-color);
            border: none;
            padding: 12px 20px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--btn-text);
            border-radius: 18px;
            margin: 8px auto;
            cursor: pointer;
            box-shadow:  6px 6px 12px var(--shadow-dark),
                        -6px -6px 12px var(--shadow-light);
            transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.3s;
            width: 100%;
            max-width: 320px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: visible;
        }

        .btn:active {
            box-shadow: inset 3px 3px 6px var(--shadow-dark),
                        inset -3px -3px 6px var(--shadow-light);
            transform: translateY(1px);
        }

        .btn.highlight {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }
        
        /* --- NEW UNIFIED BUTTON STYLES (Menu/Pause/Win) --- */
        .btn-primary-large {
            width: 100%;
            max-width: 320px;
            background: var(--play-btn-bg);
            color: var(--play-btn-text);
            border: none;
            height: 75px;
            font-size: 1.4rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 10px 20px -5px var(--play-btn-shadow);
            margin-bottom: 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-primary-large:active {
            transform: scale(0.98);
            box-shadow: 0 5px 10px -5px var(--play-btn-shadow);
        }
        
        .btn-secondary-large {
            width: 100%;
            max-width: 320px;
            background: var(--other-btn-bg);
            color: var(--other-btn-text);
            border: 2px solid var(--other-btn-border);
            height: 60px;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: none;
            border-radius: 18px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .btn-secondary-large:active {
            background: var(--floor-color);
        }

        .btn-content { text-align: left; flex: 1; }
        .btn-title { font-size: 1.1rem; }
        .btn-sub { font-size: 0.8rem; opacity: 0.6; margin-top: 2px; font-weight: 500; }

        .btn-small-icon {
            width: 55px;
            height: 55px;
            min-width: 55px;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0 10px;
            display: flex;
        }
        
        /* Icons */
        .icon-svg {
            width: 24px;
            height: 24px;
            fill: var(--btn-text);
            transition: fill 0.3s;
        }
        .btn.highlight .icon-svg { fill: var(--primary-color); }
        .btn.locked .icon-svg { opacity: 0.7; }

        /* --- SETTINGS TOGGLE --- */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: var(--shadow-dark);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.on { background: var(--primary-color); }
        
        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.on .toggle-knob { transform: translateX(22px); }

        /* --- HUD --- */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.3s;
        }
        #hud.hidden { opacity: 0; }

        .hud-item {
            background: var(--modal-bg);
            padding: 10px 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 0.95rem;
            color: var(--text-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            pointer-events: auto;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hud-item:active { transform: scale(0.95); }

        /* --- MODALS --- */
        .modal-card {
            background: var(--modal-bg);
            padding: 30px;
            border-radius: 35px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            width: 90%;
            max-width: 360px;
            transition: background-color 0.3s;
            max-height: 90vh; /* Prevent modal overflow */
            overflow-y: auto;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }

        .stat-box {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 20px;
            transition: background-color 0.3s;
        }

        .stat-val { font-size: 1.4rem; font-weight: 900; color: var(--text-color); }
        .stat-label { font-size: 0.7rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* --- SCROLL CONTAINERS --- */
        .menu-scroll {
            width: 100%;
            flex: 1; 
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 0 20px 0; 
            scrollbar-width: none;
            mask-image: linear-gradient(to bottom, transparent, black 10px, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10px, black 90%, transparent);
            min-height: 0; 
        }
        .menu-scroll::-webkit-scrollbar { display: none; }
        
        /* --- OTHER GAMES GRID --- */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Changed to 4 columns */
            gap: 8px;
            width: 100%;
            padding: 10px 2px;
        }
        .game-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .game-item:active { transform: scale(0.95); }
        .game-icon-box {
            width: 100%; 
            aspect-ratio: 1; 
            background: var(--floor-color);
            border-radius: 14px; /* Slightly smaller radius */
            margin-bottom: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .game-icon-img { width: 100%; height: 100%; object-fit: cover; }
        .game-title {
            font-size: 0.65rem; /* Smaller font */
            font-weight: 600;
            text-align: center;
            line-height: 1.1;
            color: var(--text-color);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- RULES ANIMATION --- */
        .rules-demo {
            width: 280px;
            height: 100px;
            background: var(--bg-color);
            border-radius: 16px;
            position: relative;
            margin: 0 auto 25px auto;
            overflow: hidden;
            border: 2px solid var(--floor-color);
        }
        
        .demo-wall { position: absolute; background: var(--wall-color); border-radius: 2px; }
        .w-top { top: 0; left: 0; width: 100%; height: 6px; }
        .w-bot { bottom: 0; left: 0; width: 100%; height: 6px; }
        .w-left { top: 0; left: 0; width: 6px; height: 100%; }
        .w-right { top: 0; right: 0; width: 6px; height: 100%; }
        
        .demo-target {
            position: absolute; width: 30px; height: 30px;
            background: rgba(79, 209, 197, 0.3);
            border-radius: 8px; 
            right: 6px; top: 35px;
            display: flex; justify-content: center; align-items: center;
        }
        .demo-target-inner { width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; }
        
        .demo-player {
            position: absolute; width: 26px; height: 26px;
            background: var(--primary-color); border-radius: 8px;
            box-shadow: 0 4px 10px rgba(79, 209, 197, 0.4);
            display: flex; justify-content: center; align-items: center; gap: 4px;
            top: 37px;
            animation: exactSlide 3s infinite ease-in-out;
        }
        .demo-eye { width: 4px; height: 4px; background: white; border-radius: 50%; }

        @keyframes exactSlide {
            0% { left: 8px; opacity: 0; transform: scale(0.8); }
            15% { left: 8px; opacity: 1; transform: scale(1); }
            45% { left: 244px; }
            70% { left: 244px; opacity: 1; transform: scale(1); }
            85% { left: 244px; opacity: 0; transform: scale(1.2); }
            100% { left: 8px; opacity: 0; transform: scale(0.8); }
        }

    </style>
</head>
<body>

<audio id="bg-music" loop src="music.mp3"></audio>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden">
        <div class="hud-item" id="btn-pause">
            <svg viewBox="0 0 24 24" class="icon-svg" style="width:16px; height:16px;"><rect x="6" y="4" width="4" height="16" rx="1" ry="1"></rect><rect x="14" y="4" width="4" height="16" rx="1" ry="1"></rect></svg>
        </div>
        <div class="hud-item" style="cursor: default;" id="level-title">–£–†–û–í–ï–ù–¨ 1</div>
        <div class="hud-item" id="btn-reset">
            <svg viewBox="0 0 24 24" class="icon-svg" style="width:20px; height:20px;"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm-8 8c0-1.01.25-1.97.7-2.8L3.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3c-3.31 0-6-2.69-6-6z"></path></svg>
        </div>
    </div>

    <!-- MAIN START SCREEN -->
    <div id="screen-main" class="screen active">
        <div style="flex:1"></div>
        <h1>–ì–ª–∞–π–¥–∏–∫—Å</h1>
        
        <div style="width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 8px;">
            <button class="btn-primary-large" onclick="Game.showLevelSelection()">
                –ò–≥—Ä–∞—Ç—å
            </button>

            <button class="btn-secondary-large" onclick="Game.showOtherGames()">
                –î—Ä—É–≥–∏–µ –∏–≥—Ä—ã
            </button>
        </div>
        
        <div style="display: flex; justify-content: center; width: 100%; margin-top: 40px; gap: 15px;">
            <button class="btn btn-small-icon" onclick="Game.showSettings()">
                <svg viewBox="0 0 24 24" class="icon-svg" style="width:28px;height:28px;"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></svg>
            </button>
            <button class="btn btn-small-icon" onclick="Game.showRules()">
                <span style="font-size: 1.5rem; font-weight: 900;">?</span>
            </button>
        </div>
        <div style="flex:1"></div>
    </div>

    <!-- LEVEL SELECTION SCREEN -->
    <div id="screen-levels" class="screen">
        <h2 style="margin-bottom: 10px;">–£—Ä–æ–≤–Ω–∏</h2>
        <div class="menu-scroll">
            <button class="btn" id="btn-mode-0" onclick="Game.startMode(0)">
                <div class="btn-content">
                    <div class="btn-title">–ù–æ–≤–∏—á–æ–∫ (5x5)</div>
                    <div class="btn-sub" id="sub-0">–£—Ä–æ–≤–µ–Ω—å 1</div>
                </div>
                <div class="btn-icon"></div>
            </button>

            <button class="btn" id="btn-mode-1" onclick="Game.startMode(1)">
                <div class="btn-content">
                    <div class="btn-title">–õ—é–±–∏—Ç–µ–ª—å (6x6)</div>
                    <div class="btn-sub" id="sub-1">–ó–∞–∫—Ä—ã—Ç–æ</div>
                </div>
                <div class="btn-icon"></div>
            </button>

            <button class="btn" id="btn-mode-2" onclick="Game.startMode(2)">
                <div class="btn-content">
                    <div class="btn-title">–ú–∞—Å—Ç–µ—Ä (8x8)</div>
                    <div class="btn-sub" id="sub-2">–ó–∞–∫—Ä—ã—Ç–æ</div>
                </div>
                <div class="btn-icon"></div>
            </button>
            
            <button class="btn" id="btn-mode-3" onclick="Game.startMode(3)">
                <div class="btn-content">
                    <div class="btn-title">–≠–∫—Å–ø–µ—Ä—Ç (10x10)</div>
                    <div class="btn-sub" id="sub-3">–ó–∞–∫—Ä—ã—Ç–æ</div>
                </div>
                <div class="btn-icon"></div>
            </button>
            
            <button class="btn" id="btn-mode-4" onclick="Game.startMode(4)">
                <div class="btn-content">
                    <div class="btn-title">–ì—É—Ä—É (12x12)</div>
                    <div class="btn-sub" id="sub-4">–ó–∞–∫—Ä—ã—Ç–æ</div>
                </div>
                <div class="btn-icon"></div>
            </button>
        </div>
        <button class="btn-primary-large" onclick="Game.showMenu()" style="width: 100%; margin-top: 10px; height: 60px;">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- OTHER GAMES SCREEN -->
    <div id="screen-other-games" class="screen">
        <div class="modal-card" style="width: 100%; max-width: 400px; padding: 25px; display: flex; flex-direction: column; height: 90%;">
            <h2 class="text-3xl font-bold mb-6">–î—Ä—É–≥–∏–µ –∏–≥—Ä—ã</h2>
            <div class="menu-scroll">
                <div class="games-grid" id="other-games-container"></div>
            </div>
            <button class="btn-secondary-large" onclick="Game.showMenu()" style="width: 100%; margin-top: 10px; height: 60px;">
                –ù–∞–∑–∞–¥
            </button>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="screen-settings" class="screen">
        <div class="modal-card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            
            <div class="toggle-row" onclick="Game.toggleSound()">
                <span class="btn-title">–ó–≤—É–∫</span>
                <div class="toggle-switch" id="toggle-sound">
                    <div class="toggle-knob"></div>
                </div>
            </div>

            <div class="toggle-row" onclick="Game.toggleVibration()">
                <span class="btn-title">–í–∏–±—Ä–∞—Ü–∏—è</span>
                <div class="toggle-switch" id="toggle-vibration">
                    <div class="toggle-knob"></div>
                </div>
            </div>

            <div class="toggle-row" onclick="Game.toggleTheme()">
                <span class="btn-title">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <div class="toggle-switch" id="toggle-theme">
                    <div class="toggle-knob"></div>
                </div>
            </div>

            <button class="btn-primary-large" onclick="Game.showMenu()" style="width: 100%; margin-top: 20px; height: 60px;">
                –ì–æ—Ç–æ–≤–æ
            </button>
        </div>
    </div>

    <!-- RULES SCREEN -->
    <div id="screen-rules" class="screen">
        <div class="modal-card">
            <h2>–ü—Ä–∞–≤–∏–ª–∞</h2>
            <div class="rules-demo">
                <div class="demo-wall w-top"></div>
                <div class="demo-wall w-bot"></div>
                <div class="demo-wall w-left"></div>
                <div class="demo-wall w-right"></div>
                
                <div class="demo-target">
                    <div class="demo-target-inner"></div>
                </div>
                <div class="demo-player">
                    <div class="demo-eye"></div><div class="demo-eye"></div>
                </div>
            </div>

            <p style="text-align: left; font-size: 0.95rem;">
                1. –°–≤–∞–π–ø–∞–π –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è.<br>
                2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ —É —Å—Ç–µ–Ω.<br>
                3. –¶–µ–ª—å: –∑–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞.<br>
            </p>
            <button class="btn-primary-large" onclick="Game.showMenu()" style="width: 100%; margin: 0; height: 60px;">
                –ü–æ–Ω—è—Ç–Ω–æ
            </button>
        </div>
    </div>

    <!-- PAUSE SCREEN -->
    <div id="screen-pause" class="screen">
        <div class="modal-card">
            <h2>–ü–∞—É–∑–∞</h2>
            <button class="btn-primary-large" onclick="Game.resumeGame()">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
            <button class="btn-secondary-large" onclick="Game.quitToMenu()">
                –í –º–µ–Ω—é
            </button>
        </div>
    </div>

    <!-- WIN SCREEN -->
    <div id="screen-win" class="screen">
        <div class="modal-card">
            <span style="font-size: 3rem;">‚ú®</span>
            <h2>–ü—Ä–æ–π–¥–µ–Ω–æ!</h2>
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-val" id="win-moves">0</div>
                    <div class="stat-label">–•–æ–¥–æ–≤</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="win-total">0</div>
                    <div class="stat-label">–ü–æ–±–µ–¥</div>
                </div>
            </div>
            <button class="btn-primary-large" onclick="Game.finishLevelAndNext()">
                –î–∞–ª—å—à–µ
            </button>
            <button class="btn-secondary-large" onclick="Game.quitToMenu()">
                –í –º–µ–Ω—é
            </button>
        </div>
    </div>

    <!-- UNLOCK SCREEN -->
    <div id="screen-unlock" class="screen">
        <div class="modal-card">
            <span style="font-size: 3rem;">üîì</span>
            <h2>–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å!</h2>
            <p>–¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –º–∞—Å—Ç–µ—Ä. –°–ª–µ–¥—É—é—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞.</p>
            <button class="btn-primary-large" onclick="Game.switchToNextMode()">
                –ü–µ—Ä–µ–π—Ç–∏
            </button>
            <button class="btn-secondary-large" onclick="Game.stayOnCurrentMode()">
                –û—Å—Ç–∞—Ç—å—Å—è
            </button>
        </div>
    </div>

</div>

<script>
class AudioManager {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = 0.3;
        this.masterGain.connect(this.ctx.destination);
        this.enabled = true;
        this.vibration = true;
    }

    playTone(freq, type, duration, slideFreq = null) {
        if (!this.enabled) return;
        if (this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if (slideFreq) {
            osc.frequency.exponentialRampToValueAtTime(slideFreq, this.ctx.currentTime + duration);
        }

        gain.gain.setValueAtTime(1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

        osc.connect(gain);
        gain.connect(this.masterGain);
        
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }

    playMove() { this.playTone(300, 'sine', 0.1, 100); }
    playHit() { this.playTone(100, 'triangle', 0.08); }
    playWin() {
        this.playTone(400, 'sine', 0.3);
        setTimeout(() => this.playTone(500, 'sine', 0.3), 100);
        setTimeout(() => this.playTone(800, 'sine', 0.6), 250);
    }
    playClick() { 
        // Pleasant pop sound (Sine wave with quick decay)
        this.playTone(600, 'sine', 0.08); 
    }
    playUnlock() {
        if (!this.enabled) return;
        this.playTone(300, 'sine', 0.2);
        setTimeout(() => this.playTone(400, 'sine', 0.2), 150);
        setTimeout(() => this.playTone(500, 'sine', 0.2), 300);
        setTimeout(() => this.playTone(600, 'sine', 0.4), 450);
    }
    
    // Taptic
    vibrate(type) {
        if (!this.vibration) return;
        if (typeof vkBridge !== 'undefined' && vkBridge.send) {
            try {
                if (type === 'light') vkBridge.send('VKWebAppTapticImpactOccurred', {style: 'light'});
                else if (type === 'medium') vkBridge.send('VKWebAppTapticImpactOccurred', {style: 'medium'});
                else if (type === 'heavy') vkBridge.send('VKWebAppTapticImpactOccurred', {style: 'heavy'});
                else if (type === 'success') vkBridge.send('VKWebAppTapticNotificationOccurred', {type: 'success'});
                return;
            } catch(e) {}
        }
        if (navigator.vibrate) {
            if (type === 'light') navigator.vibrate(10);
            else if (type === 'medium') navigator.vibrate(20);
            else if (type === 'heavy') navigator.vibrate(40);
            else if (type === 'success') navigator.vibrate([50, 30, 50]);
        }
    }
}

class LevelGenerator {
    constructor(width, height) {
        this.width = width;
        this.height = height;
    }

    generate() {
        for (let i = 0; i < 500; i++) {
            const level = this.createRandomLayout();
            const solution = this.solve(level);
            
            let minPath = 5; 
            if (this.width >= 6) minPath = 6;
            if (this.width >= 8) minPath = 8;
            if (this.width >= 10) minPath = 10;

            if (solution && solution.length >= minPath) {
                level.minMoves = solution.length;
                return level;
            }
        }
        return this.createFallbackLevel();
    }

    createRandomLayout() {
        let walls = [];
        let density = 0.22;
        if (this.width > 8) density = 0.18;

        let wallCount = Math.floor((this.width * this.height) * density);
        
        for(let i=0; i<wallCount; i++) {
            walls.push({
                x: Math.floor(Math.random() * this.width),
                y: Math.floor(Math.random() * this.height)
            });
        }

        let start, end;
        do {
            start = {x: Math.floor(Math.random() * this.width), y: Math.floor(Math.random() * this.height)};
        } while (this.isWall(walls, start.x, start.y));

        do {
            end = {x: Math.floor(Math.random() * this.width), y: Math.floor(Math.random() * this.height)};
        } while (this.isWall(walls, end.x, end.y) || (start.x === end.x && start.y === end.y));

        return { width: this.width, height: this.height, walls, start, end };
    }

    isWall(walls, x, y) {
        return walls.some(w => w.x === x && w.y === y);
    }

    solve(level) {
        const queue = [{x: level.start.x, y: level.start.y, path: []}];
        const visited = new Set();
        visited.add(`${level.start.x},${level.start.y}`);
        const directions = [{dx:0, dy:-1}, {dx:0, dy:1}, {dx:-1, dy:0}, {dx:1, dy:0}];

        while(queue.length > 0) {
            const curr = queue.shift();
            if (curr.x === level.end.x && curr.y === level.end.y) return curr.path;

            for (let dir of directions) {
                let nx = curr.x;
                let ny = curr.y;
                let steps = 0;
                
                while(true) {
                    let nextX = nx + dir.dx;
                    let nextY = ny + dir.dy;
                    if (nextX < 0 || nextX >= level.width || nextY < 0 || nextY >= level.height) break;
                    if (this.isWall(level.walls, nextX, nextY)) break;
                    nx = nextX; ny = nextY;
                    steps++;
                }

                if (steps > 0 && !visited.has(`${nx},${ny}`)) {
                    visited.add(`${nx},${ny}`);
                    queue.push({x: nx, y: ny, path: [...curr.path, dir]});
                }
            }
        }
        return null;
    }

    createFallbackLevel() {
        return {
            width: 5, height: 5,
            walls: [{x:1, y:1}, {x:3, y:3}],
            start: {x:0, y:0},
            end: {x:4, y:4},
            minMoves: 3 
        };
    }
}

class ZenGlider {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d', { alpha: false }); 
        this.audio = new AudioManager();
        
        this.winsToUnlock = 20;
        this.vkUserId = null;
        
        this.levelsSinceAd = 0;

        this.state = {
            mode: 0,
            levelData: null,
            player: {x:0, y:0, tx:0, ty:0, moving: false},
            moves: 0,
            wins: [0, 0, 0, 0, 0], 
            unlocks: [true, false, false, false, false],
            status: 'menu',
            settings: { sound: true, vibration: true, dark: false }
        };

        this.particles = [];
        this.cellSize = 0;
        this.padding = 20;
        this.isDragging = false;
        
        this.colors = {
            bg: '#eef2f5',
            floor: '#e2e8f0',
            wall: '#a0aec0',
            wallShadow: '#718096',
            player: '#4fd1c5',
            target: '#9ae6b4',
            targetDot: '#2f855a'
        };
        
        // Music Logic
        this.bgMusic = document.getElementById('bg-music');
        this.bgMusic.volume = 0.1; // Very quiet background music
        this.wasMusicPlaying = false;

        // VK Initialization & Loading
        this.initVK().then(() => {
             this.loadProgress(); 
             this.initAfterLoad();
        });

        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.setupInput();

        this.lastTime = 0;
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
        
        this.renderOtherGames();

        // Initialize music on first interaction
        document.body.addEventListener('click', () => {
            if (this.state.settings.sound && this.bgMusic.paused) {
                this.bgMusic.play().catch(e => {});
            }
        }, { once: true });
    }
    
    async initVK() {
        if (typeof vkBridge !== 'undefined') {
            try {
                await vkBridge.send('VKWebAppInit');
                
                // Music Pause/Resume on Minimize/Restore
                vkBridge.subscribe(e => {
                    if (e.detail.type === 'VKWebAppViewHide') {
                        if (!this.bgMusic.paused) {
                            this.wasMusicPlaying = true;
                            this.bgMusic.pause();
                        }
                    }
                    if (e.detail.type === 'VKWebAppViewRestore') {
                        if (this.wasMusicPlaying && this.state.settings.sound) {
                            this.bgMusic.play().catch(e => {});
                        }
                        this.wasMusicPlaying = false;
                    }
                });

                // Banner Ad
                vkBridge.send('VKWebAppShowBannerAd', { banner_location: 'bottom' }).catch(e => console.log('Ad error', e));
                // Interstitial check
                vkBridge.send('VKWebAppCheckNativeAds', { ad_format: 'interstitial' });

                const user = await vkBridge.send('VKWebAppGetUserInfo');
                this.vkUserId = user.id;
            } catch (error) {
                console.warn("VK Bridge Init Error:", error);
            }
        }
    }
    
    initAfterLoad() {
        if (this.state.settings.dark) {
            document.body.classList.add('dark-mode');
            this.updateThemeColors();
        }
        this.updateSettingsUI();
        
        // Start music if loaded and settings allow
        if(this.state.settings.sound) {
             this.bgMusic.play().catch(e => {});
        }
    }

    updateThemeColors() {
        const style = getComputedStyle(document.body);
        this.colors.bg = style.getPropertyValue('--bg-color').trim();
        this.colors.floor = style.getPropertyValue('--floor-color').trim();
        this.colors.wall = style.getPropertyValue('--wall-color').trim();
        this.colors.wallShadow = this.state.settings.dark ? '#000000' : '#718096';
    }

    async loadProgress() {
        if (this.vkUserId) {
             const storageKey = `zenglider_data_${this.vkUserId}`;
             try {
                const response = await vkBridge.send('VKWebAppStorageGet', { keys: [storageKey] });
                if (response.keys[0]?.value) {
                    this.applyData(JSON.parse(response.keys[0].value));
                    return; 
                }
             } catch(e) { console.warn("VK Storage Load Failed", e); }
        }

        const saved = localStorage.getItem('zenGliderSave_v4');
        if (saved) {
            this.applyData(JSON.parse(saved));
        }
    }
    
    applyData(parsed) {
        this.state.wins = parsed.wins || [0,0,0,0,0];
        if (parsed.currentLevel) this.savedLevel = parsed.currentLevel;
        if (parsed.settings) {
            this.state.settings = { ...this.state.settings, ...parsed.settings };
            this.audio.enabled = this.state.settings.sound;
            this.audio.vibration = this.state.settings.vibration;
        }
        this.checkUnlocks();
        this.updateMenuUI(); 
        this.updateSettingsUI();
        if(this.state.settings.dark) {
             document.body.classList.add('dark-mode');
             this.updateThemeColors();
        }
    }

    async saveProgress(shouldSaveLevel = true) {
        this.checkUnlocks();
        const data = {
            wins: this.state.wins,
            currentLevel: shouldSaveLevel ? this.state.levelData : null,
            settings: this.state.settings
        };
        const dataStr = JSON.stringify(data);
        
        if (this.vkUserId) {
            const storageKey = `zenglider_data_${this.vkUserId}`;
            vkBridge.send('VKWebAppStorageSet', { key: storageKey, value: dataStr }).catch(e => console.warn(e));
        }
        
        localStorage.setItem('zenGliderSave_v4', dataStr);
        this.updateMenuUI();
    }

    toggleSound() {
        this.state.settings.sound = !this.state.settings.sound;
        this.audio.enabled = this.state.settings.sound;
        
        if(this.state.settings.sound) {
            this.audio.playClick();
            this.audio.vibrate('light');
            this.bgMusic.play().catch(e => {});
        } else {
            this.bgMusic.pause();
        }
        
        this.saveProgress(false);
        this.updateSettingsUI();
    }

    toggleVibration() {
        this.state.settings.vibration = !this.state.settings.vibration;
        this.audio.vibration = this.state.settings.vibration;
        if(this.state.settings.vibration) this.audio.vibrate('success');
        this.saveProgress(false);
        this.updateSettingsUI();
    }

    toggleTheme() {
        this.state.settings.dark = !this.state.settings.dark;
        document.body.classList.toggle('dark-mode');
        this.updateThemeColors();
        this.audio.playClick();
        this.audio.vibrate('light');
        this.saveProgress(false);
        this.updateSettingsUI();
        this.draw(); 
    }

    updateSettingsUI() {
        const soundEl = document.getElementById('toggle-sound');
        const vibEl = document.getElementById('toggle-vibration');
        const themeEl = document.getElementById('toggle-theme');
        
        if (this.state.settings.sound) soundEl.classList.add('on'); else soundEl.classList.remove('on');
        if (this.state.settings.vibration) vibEl.classList.add('on'); else vibEl.classList.remove('on');
        if (this.state.settings.dark) themeEl.classList.add('on'); else themeEl.classList.remove('on');
    }

    checkUnlocks() {
        for(let i=0; i<4; i++) {
            if (this.state.wins[i] >= this.winsToUnlock) {
                this.state.unlocks[i+1] = true;
            }
        }
    }

    resize() {
        const parent = this.canvas.parentElement;
        this.canvas.width = parent.clientWidth * window.devicePixelRatio;
        this.canvas.height = parent.clientHeight * window.devicePixelRatio;
        this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        this.virtualWidth = parent.clientWidth;
        this.virtualHeight = parent.clientHeight;
        this.draw();
    }

    showMenu() {
        this.state.status = 'menu';
        this.audio.vibrate('light');
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('screen-main').classList.add('active');
        document.getElementById('hud').classList.add('hidden');
    }

    showLevelSelection() {
        this.audio.vibrate('light');
        document.getElementById('screen-main').classList.remove('active');
        document.getElementById('screen-levels').classList.add('active');
        this.updateMenuUI();
    }

    startMode(modeIndex) {
        if (!this.state.unlocks[modeIndex]) return;
        this.state.mode = modeIndex;
        this.audio.playClick();
        this.audio.vibrate('light');
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('hud').classList.remove('hidden');
        if (this.savedLevel && this.savedLevel.modeIndex === modeIndex) {
            this.loadLevel(this.savedLevel);
        } else {
            this.generateNewLevel();
        }
    }

    generateNewLevel() {
        let size = 5;
        if (this.state.mode === 1) size = 6;
        if (this.state.mode === 2) size = 8;
        if (this.state.mode === 3) size = 10;
        if (this.state.mode === 4) size = 12;

        const gen = new LevelGenerator(size, Math.floor(size * 1.2)); 
        const data = gen.generate();
        data.modeIndex = this.state.mode; 
        this.loadLevel(data);
        this.saveProgress(true);
    }

    loadLevel(data) {
        this.state.levelData = data;
        this.state.player.x = data.start.x;
        this.state.player.y = data.start.y;
        this.state.player.tx = data.start.x;
        this.state.player.ty = data.start.y;
        this.state.player.moving = false;
        this.state.moves = 0;
        this.state.status = 'playing';
        
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        
        const lvlNum = this.state.wins[this.state.mode] + 1;
        document.getElementById('level-title').innerText = `–£–†–û–í–ï–ù–¨ ${lvlNum}`;

        const maxW = this.virtualWidth - (this.padding * 2);
        const maxH = this.virtualHeight - 110; 
        this.cellSize = Math.min(maxW / data.width, maxH / data.height);
        
        // Strict Vertical Centering
        this.offsetX = (this.virtualWidth - (data.width * this.cellSize)) / 2;
        this.offsetY = (this.virtualHeight - (data.height * this.cellSize)) / 2;
    }

    finishLevelAndNext() {
        this.audio.playClick();
        this.audio.vibrate('light');
        document.getElementById('screen-win').classList.remove('active');
        this.savedLevel = null;
        this.generateNewLevel();
    }
    
    switchToNextMode() {
        this.audio.playClick();
        this.audio.vibrate('success');
        document.getElementById('screen-unlock').classList.remove('active');
        this.startMode(this.state.mode + 1);
    }
    
    stayOnCurrentMode() {
        this.audio.playClick();
        this.audio.vibrate('light');
        document.getElementById('screen-unlock').classList.remove('active');
        this.finishLevelAndNext();
    }

    setupInput() {
        let startX = null, startY = null;
        
        const handleStart = (x, y) => { 
            startX = x; startY = y; 
            this.isDragging = true;
        };
        
        const handleEnd = (x, y) => {
            if (this.state.status !== 'playing' || !this.isDragging || startX === null) {
                this.isDragging = false;
                return;
            }
            
            const dx = x - startX;
            const dy = y - startY;
            if (Math.abs(dx) > Math.abs(dy)) {
                if (Math.abs(dx) > 30) this.move(dx > 0 ? 1 : -1, 0);
            } else {
                if (Math.abs(dy) > 30) this.move(0, dy > 0 ? 1 : -1);
            }
            this.isDragging = false;
            startX = null; 
        };

        this.canvas.addEventListener('touchstart', e => handleStart(e.touches[0].clientX, e.touches[0].clientY), {passive: false});
        this.canvas.addEventListener('touchend', e => {
            e.preventDefault();
            handleEnd(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        }, {passive: false});

        this.canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
        
        window.addEventListener('mouseup', e => {
            if(this.isDragging) handleEnd(e.clientX, e.clientY);
        });

        window.addEventListener('keydown', (e) => {
            if (this.state.status !== 'playing') return;
            if (e.key === 'ArrowUp') this.move(0, -1);
            if (e.key === 'ArrowDown') this.move(0, 1);
            if (e.key === 'ArrowLeft') this.move(-1, 0);
            if (e.key === 'ArrowRight') this.move(1, 0);
        });

        const pauseBtn = document.getElementById('btn-pause');
        pauseBtn.onclick = (e) => {
            e.stopPropagation(); 
            if(this.state.status === 'playing') {
                this.audio.vibrate('light');
                this.state.status = 'pause';
                document.getElementById('screen-pause').classList.add('active');
            }
        };
        pauseBtn.addEventListener('touchstart', (e) => e.stopPropagation());

        const resetBtn = document.getElementById('btn-reset');
        resetBtn.onclick = (e) => {
            e.stopPropagation(); 
            this.audio.playClick();
            this.audio.vibrate('medium');
            this.loadLevel(this.state.levelData);
        };
        resetBtn.addEventListener('touchstart', (e) => e.stopPropagation());
    }

    move(dx, dy) {
        if (this.state.player.moving) return;

        let cx = this.state.player.x;
        let cy = this.state.player.y;
        let moved = false;

        while(true) {
            let nx = cx + dx;
            let ny = cy + dy;
            if (nx < 0 || nx >= this.state.levelData.width || ny < 0 || ny >= this.state.levelData.height) break;
            if (this.state.levelData.walls.some(w => w.x === nx && w.y === ny)) break;
            cx = nx; cy = ny; moved = true;
        }

        if (moved) {
            this.state.player.tx = cx;
            this.state.player.ty = cy;
            this.state.player.moving = true;
            this.state.moves++;
            this.audio.playMove();
            this.audio.vibrate('light');
        }
    }

    update(dt) {
        if (this.state.player.moving) {
            const speed = 20 * dt; 
            const p = this.state.player;
            const dx = p.tx - p.x;
            const dy = p.ty - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < speed) {
                p.x = p.tx;
                p.y = p.ty;
                p.moving = false;
                this.onMoveEnd();
            } else {
                p.x += (dx / dist) * speed;
                p.y += (dy / dist) * speed;
                if (Math.random() > 0.6) {
                    this.spawnParticle(
                        this.offsetX + p.x * this.cellSize + this.cellSize/2,
                        this.offsetY + p.y * this.cellSize + this.cellSize/2,
                        this.colors.player
                    );
                }
            }
        }

        for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            p.life -= dt * 2.5;
            p.x += p.vx * dt * 60;
            p.y += p.vy * dt * 60;
            if (p.life <= 0) this.particles.splice(i, 1);
        }
    }

    onMoveEnd() {
        this.audio.playHit();
        this.audio.vibrate('medium');
        for(let i=0; i<4; i++) {
            this.spawnParticle(
                this.offsetX + this.state.player.x * this.cellSize + this.cellSize/2,
                this.offsetY + this.state.player.y * this.cellSize + this.cellSize/2,
                this.colors.wall
            );
        }

        if (Math.round(this.state.player.x) === this.state.levelData.end.x && 
            Math.round(this.state.player.y) === this.state.levelData.end.y) {
            this.levelComplete();
        }
    }

    levelComplete() {
        this.state.status = 'win';
        this.state.wins[this.state.mode]++;
        const currentWins = this.state.wins[this.state.mode];
        
        let justUnlocked = false;
        if (currentWins === this.winsToUnlock && this.state.mode < 4) {
            justUnlocked = true;
            this.audio.playUnlock();
            this.audio.vibrate('success');
        } else {
            this.audio.playWin();
            this.audio.vibrate('success');
        }

        // Ad Logic (Fixed for proper thresholds)
        this.levelsSinceAd++;
        let adThreshold = 10;
        if (this.state.mode === 2 || this.state.mode === 3) adThreshold = 6;
        if (this.state.mode === 4) adThreshold = 4;

        if (this.levelsSinceAd >= adThreshold) {
            if (typeof vkBridge !== 'undefined') {
                vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'interstitial' })
                    .catch(e => console.log('Ad error', e));
            }
            this.levelsSinceAd = 0;
        }

        this.savedLevel = null; 
        this.saveProgress(false); 

        setTimeout(() => {
            if (justUnlocked) {
                 document.getElementById('screen-unlock').classList.add('active');
            } else {
                document.getElementById('win-moves').innerText = this.state.moves;
                document.getElementById('win-total').innerText = currentWins;
                document.getElementById('screen-win').classList.add('active');
            }
            
            for(let i=0; i<40; i++) {
                this.spawnParticle(
                    this.virtualWidth/2, this.virtualHeight/2, 
                    ['#f6ad55', '#4fd1c5', '#fc8181'][Math.floor(Math.random()*3)],
                    Math.random() * 5 + 3
                );
            }
        }, 400);
    }

    spawnParticle(x, y, color, sizeBase = 2) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 2 + 1;
        this.particles.push({
            x, y, color,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            life: 1.0,
            size: Math.random() * 4 + sizeBase
        });
    }

    draw() {
        // --- FIX FOR GHOST SQUARE ---
        this.ctx.shadowBlur = 0;
        this.ctx.shadowOffsetX = 0;
        this.ctx.shadowOffsetY = 0;
        this.ctx.shadowColor = 'transparent';
        
        this.ctx.fillStyle = this.colors.bg;
        this.ctx.save();
        this.ctx.setTransform(1, 0, 0, 1, 0, 0); 
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.restore();

        if (!this.state.levelData) return;

        const ld = this.state.levelData;
        const cs = this.cellSize;
        const pad = 3;

        this.ctx.save();
        this.ctx.fillStyle = this.colors.floor;
        this.ctx.beginPath(); 
        for(let y=0; y<ld.height; y++) {
            for(let x=0; x<ld.width; x++) {
                this.addRoundedRectPath(
                    this.offsetX + x*cs + pad, 
                    this.offsetY + y*cs + pad, 
                    cs - pad*2, cs - pad*2, 6
                );
            }
        }
        this.ctx.fill(); 
        this.ctx.restore();

        this.ctx.save();
        this.ctx.fillStyle = this.colors.target;
        let tx = this.offsetX + ld.end.x*cs + pad;
        let ty = this.offsetY + ld.end.y*cs + pad;
        this.drawRoundedRect(tx, ty, cs - pad*2, cs - pad*2, 8);
        this.ctx.fill();
        this.ctx.fillStyle = this.colors.targetDot;
        this.ctx.beginPath();
        this.ctx.arc(
            tx + (cs - pad*2)/2,
            ty + (cs - pad*2)/2,
            (cs - pad*2)/6, 0, Math.PI*2
        );
        this.ctx.fill();
        this.ctx.restore();

        this.ctx.save();
        this.ctx.fillStyle = this.colors.wall;
        this.ctx.shadowColor = this.colors.wallShadow;
        this.ctx.shadowBlur = 0;
        this.ctx.shadowOffsetY = 4;

        this.ctx.beginPath();
        for (let w of ld.walls) {
            let wx = this.offsetX + w.x*cs + pad;
            let wy = this.offsetY + w.y*cs + pad;
            this.addRoundedRectPath(wx, wy, cs - pad*2, cs - pad*2, 6);
        }
        this.ctx.fill();
        this.ctx.restore();

        const p = this.state.player;
        this.ctx.save();
        this.ctx.fillStyle = this.colors.player;
        this.ctx.shadowColor = 'rgba(79, 209, 197, 0.4)';
        this.ctx.shadowBlur = 15;
        this.ctx.shadowOffsetY = 2;
        
        let px = this.offsetX + p.x*cs + pad;
        let py = this.offsetY + p.y*cs + pad;
        this.drawRoundedRect(px, py, cs - pad*2, cs - pad*2, 10);
        this.ctx.fill();
        this.ctx.restore();

        this.ctx.fillStyle = 'white';
        let psize = cs - pad*2;
        this.ctx.beginPath();
        this.ctx.arc(px + psize*0.3, py + psize*0.4, psize*0.1, 0, Math.PI*2);
        this.ctx.arc(px + psize*0.7, py + psize*0.4, psize*0.1, 0, Math.PI*2);
        this.ctx.fill();

        for(let part of this.particles) {
            this.ctx.globalAlpha = part.life;
            this.ctx.fillStyle = part.color;
            this.ctx.beginPath();
            this.ctx.arc(part.x, part.y, part.size, 0, Math.PI*2);
            this.ctx.fill();
        }
        this.ctx.globalAlpha = 1.0;
    }

    drawRoundedRect(x, y, w, h, r) {
        this.ctx.beginPath();
        this.addRoundedRectPath(x, y, w, h, r);
        this.ctx.closePath();
    }
    
    addRoundedRectPath(x, y, w, h, r) {
        this.ctx.moveTo(x + r, y);
        this.ctx.lineTo(x + w - r, y);
        this.ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        this.ctx.lineTo(x + w, y + h - r);
        this.ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        this.ctx.lineTo(x + r, y + h);
        this.ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        this.ctx.lineTo(x, y + r);
        this.ctx.quadraticCurveTo(x, y, x + r, y);
    }

    loop(timestamp) {
        const dt = (timestamp - this.lastTime) / 1000;
        this.lastTime = timestamp;
        this.update(dt);
        this.draw();
        requestAnimationFrame(this.loop);
    }

    updateMenuUI() {
        const icons = {
            arrow: `<svg viewBox="0 0 24 24" class="icon-svg"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"></path></svg>`,
            lock: `<svg viewBox="0 0 24 24" class="icon-svg"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"></path></svg>`
        };

        for(let i=0; i<5; i++) {
            const wins = this.state.wins[i];
            const isUnlocked = this.state.unlocks[i];
            const btn = document.getElementById(`btn-mode-${i}`);
            const subEl = document.getElementById(`sub-${i}`);
            const iconEl = btn ? btn.querySelector('.btn-icon') : null;

            if (btn && iconEl) {
                btn.classList.remove('locked', 'highlight');
                if (isUnlocked) {
                    if (subEl) subEl.innerText = `–£—Ä–æ–≤–µ–Ω—å ${wins + 1}`;
                    iconEl.innerHTML = icons.arrow;
                } else {
                    let prevWins = this.state.wins[i-1];
                    if (subEl) subEl.innerText = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${prevWins}/${this.winsToUnlock}`;
                    btn.classList.add('locked');
                    iconEl.innerHTML = icons.lock;
                }
            }
        }
    }

    showMenu() {
        this.state.status = 'menu';
        this.audio.vibrate('light');
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('screen-main').classList.add('active');
        document.getElementById('hud').classList.add('hidden');
    }
    
    showLevelSelection() {
        this.audio.vibrate('light');
        document.getElementById('screen-main').classList.remove('active');
        document.getElementById('screen-levels').classList.add('active');
        this.updateMenuUI();
    }
    
    showSettings() {
        this.audio.vibrate('light');
        document.getElementById('screen-settings').classList.add('active');
    }
    
    showRules() {
        this.audio.vibrate('light');
        document.getElementById('screen-settings').classList.remove('active');
        // REMOVED LEGACY FALLBACK THAT CAUSED ERROR
        document.getElementById('screen-main').classList.remove('active');
        document.getElementById('screen-rules').classList.add('active');
    }
    
    showOtherGames() {
        this.audio.vibrate('light');
        document.getElementById('screen-main').classList.remove('active');
        document.getElementById('screen-other-games').classList.add('active');
    }
    
    renderOtherGames() {
        const container = document.getElementById('other-games-container');
        if(!container) return;
        container.innerHTML = '';
        
        const games = [
            { name: 'Bubble Shooter', appId: 54051411, icon: 'icon1.png' }, 
            { name: '–¢–µ—Ç—Ä–∏—Å', appId: 54051413, icon: 'icon2.png' },
            { name: 'Tower Blocks', appId: 53962513, icon: 'icon3.png' }, 
            { name: '–ë–ª–æ–∫ –ü—Ä–æ', appId: 53936296, icon: 'icon4.png' },
            { name: '–§–∏–ª–≤–æ—Ä–¥—ã', appId: 53867134, icon: 'icon5.png' }, 
            { name: '–°–ª–æ–≤–ª–∏', appId: 53861990, icon: 'icon6.png' },
            { name: 'Brick Balls', appId: 54023580, icon: 'icon7.png' }, 
            { name: '2048', appId: 53965380, icon: 'icon8.png' },
            { name: 'Math Matrix', appId: 53970659, icon: 'icon9.png' }
        ];

        games.forEach(game => {
            const item = document.createElement('div');
            item.className = 'game-item';
            item.onclick = () => {
                this.audio.vibrate('light');
                if (typeof vkBridge !== 'undefined') {
                    vkBridge.send('VKWebAppOpenApp', { app_id: game.appId });
                } else {
                    console.log(`Opening app ${game.appId}`);
                }
            };
            
            // Note: Using placeholder colors for icons since files aren't physically present
            item.innerHTML = `
                <div class="game-icon-box">
                    <img src="${game.icon}" alt="${game.name}" class="game-icon-img" onerror="this.style.display='none';this.parentNode.style.backgroundColor='#cbd5e0'">
                </div>
                <div class="game-title">${game.name}</div>
            `;
            container.appendChild(item);
        });
    }

    resumeGame() {
        this.state.status = 'playing';
        this.audio.vibrate('light');
        document.getElementById('screen-pause').classList.remove('active');
    }

    quitToMenu() {
        this.showMenu();
        document.getElementById('screen-pause').classList.remove('active');
        document.getElementById('screen-win').classList.remove('active');
        this.savedLevel = this.state.levelData; 
        this.saveProgress(true);
    }
}

const Game = new ZenGlider();
</script>
</body>
</html>